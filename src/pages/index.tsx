import Head from "next/head"
import React, { useState, useEffect } from "react"
import { GoogleMap, useLoadScript, Marker, Polygon, OverlayView } from "@react-google-maps/api"
import axios from "axios"

import Navbar from "@/components/navbar"
import BarButtons from "@/components/barButtons"
import Button from "@/components/button"

import COORDONNEES_REGION from "@/utils/coordonnees_region"
import OPTIONS from "@/utils/optionsMap"
import MAPCONTAINERSTYLES from "@/utils/styleMap"
import { chooseDate } from "@/utils/chooseDate"

import styles from "./index.module.scss"
import { Flex } from "@chakra-ui/react"

export default function Index() {
    const { isLoaded } = useLoadScript({
        googleMapsApiKey: "AIzaSyDbr6FgqPsctO5kXmIFoYL7X7TuaXAGX_o",
    })

    if (!isLoaded) return <div>Loading...</div>
    return <Map />
}

function Map() {
    const [temps, setTemps] = useState<any>([])
    const [previsionsDate, setPrevisionsDate] = useState<any>({})
    const [boutons, setBoutons] = useState<any>({})
    useEffect(() => {
        setPrevisionsDate(chooseDate())
        setBoutons({
            bouton1: true,
            bouton2: false,
            button3: false,
            button4: false,
            button5: false,
            button6: false,
        })

        const fetchData = async () => {
            try {
                const requests = COORDONNEES_REGION.map(async element => {
                    const response = await axios.get(
                        `https://api.openweathermap.org/data/2.5/weather?lat=${element.lat}&lon=${element.lng}&date=2023-11-21&units=metric&appid=95ac755812151c92c3f2191d0124d8d2`,
                    )
                    return {
                        lat: element.lat,
                        lng: element.lng,
                        temps: response.data.weather[0].icon,
                        degres: Math.floor(response.data.main.temp),
                    }
                })

                const results = await Promise.all(requests)

                setTemps(results)
            } catch (error) {
                console.error(error)
            }
        }

        fetchData()
    }, [])

    // const test = async () => {
    //     await axios
    //         .get(
    //             // `https://api.openweathermap.org/data/2.5/weather?lat=49.6339308&lon=-1.622137&date=2023-11-21&tz=+16:00&units=metric&appid=95ac755812151c92c3f2191d0124d8d2`,
    //             `https://api.openweathermap.org/data/2.5/onecall?lat=49.6339308&lon=-1.622137&units=metric&exclude=current,minutely,hourly&appid=95ac755812151c92c3f2191d0124d8d2`,
    //         )
    //         .then((data: any) => {
    //             console.log(data)
    //         })
    //         .catch((err: any) => {
    //             console.log(err)
    //         })
    // }

    const options = {
        styles: [
            {
                featureType: "administrative",
                elementType: "geometry.stroke",
                stylers: [
                    {
                        color: "black",
                    },
                ],
            },
            // Enlever les noms des villes et pays
            {
                featureType: "administrative",
                elementType: "labels",
                stylers: [
                    {
                        visibility: "on",
                    },
                ],
            },
            // Masquer les routes et les lignes
            {
                featureType: "road",
                elementType: "geometry",
                stylers: [
                    {
                        visibility: "on",
                    },
                ],
            },
        ],
        draggable: true,
        zoomControl: true,
        disableDefaultUI: true,
    }
    return (
        <>
            <Head>
                <title>Météo Pas France</title>
                <meta name="description" content="Generated by create next app" />
                <meta name="viewport" content="width=device-width, initial-scale=1" />
                <link rel="icon" href="/favicon.ico" />
            </Head>
            <Navbar />
            <Button
                title="TEST"
                onClick={() => {
                    // test()
                }}
            />
            <main className={styles.main}>
                <div className={styles.map}>
                    <h1 className={styles.h1}>METEO FRANCE</h1>
                    <BarButtons
                        boutons={boutons}
                        setBoutons={setBoutons}
                        dateAujourdhui={previsionsDate.datePlus0}
                        dateDemain={previsionsDate.datePlus1}
                        datePlus2={previsionsDate.datePlus2}
                        datePlus3={previsionsDate.datePlus3}
                        datePlus4={previsionsDate.datePlus4}
                        datePlus5={previsionsDate.datePlus5}
                        datePlus6={previsionsDate.datePlus6}
                        setTemps={setTemps}
                    />

                    <GoogleMap
                        zoom={6}
                        center={{ lat: 46.6167, lng: 1.85 }}
                        mapContainerStyle={MAPCONTAINERSTYLES}
                        options={OPTIONS}
                    >
                        {/* <OverlayView
                            position={{ lat: 49.6337308, lng: -1.622137 }}
                            mapPaneName={OverlayView.OVERLAY_LAYER}
                        >
                            <div style={{ width: 100 }}>
                                <p>Matin</p>
                                <p>Après midi</p>
                                <p>Soirée</p>
                            </div>
                        </OverlayView> */}

                        {temps
                            ? temps.map((v: any, k: any) => (
                                  <div key={k}>
                                      {/* <Marker position={{ lat: v.lat, lng: v.lng }} /> */}
                                      <OverlayView
                                          position={{ lat: v.lat, lng: v.lng }}
                                          mapPaneName={OverlayView.OVERLAY_LAYER}
                                          getPixelPositionOffset={(width, height) => ({
                                              x: -30,
                                              y: -30,
                                          })}
                                      >
                                          <img
                                              src={`https://openweathermap.org/img/wn/${v.temps}@4x.png`}
                                              alt="Green double couch with wooden legs"
                                              width={60}
                                              height={60}
                                          />
                                      </OverlayView>
                                      <OverlayView
                                          key={k}
                                          position={{ lat: v.lat, lng: v.lng }}
                                          mapPaneName={OverlayView.OVERLAY_LAYER}
                                          getPixelPositionOffset={(width, height) => ({
                                              x: 10,
                                              y: -30,
                                          })}
                                      >
                                          <Flex>
                                              <p className={styles.degres}>
                                                  {v.degres.toString()}°
                                              </p>
                                          </Flex>
                                      </OverlayView>
                                  </div>
                              ))
                            : ""}
                    </GoogleMap>
                </div>
            </main>
        </>
    )
}
